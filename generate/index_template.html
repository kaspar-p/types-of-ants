<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="An informative site about ants, created by kaspar poland."
    />
    <style>
      body {
        overflow-x: hidden;
      }

      h1, h3 {
        text-align: center;
      }

      #banner {
        display: block; 
        width: 100%; 
        background-color: gold; 
        border-radius: 5px; 
        padding: 10px; 
        padding-right: 0
      }

      #scroll-container {
        overflow: hidden;
        white-space: nowrap;
      }

      #scroll-container > * {
        display: inline-block;
        margin-right: 50px;
        animation: title calc(5s * 100) infinite linear;
      }

      #ant-filler > div {
        padding-top: 5px;
        padding-bottom: 5px;
      }

      @keyframes title {
        0% {transform: translateX(0);}
        100% {transform: translateX(calc(-500px * 100));}
      }
    </style>
    <script>
      const develop = false;
      const isHandling = {
        newAnt: false,
        newsletter: false,
      };

      async function handle(action) {
        const { formID, inputID, validator, endpoint, handling } = action;

        const form = document.getElementById(formID);
        const responseText = document.createElement("div");
        form.appendChild(responseText);

        const input = document.getElementById(inputID);
        input.value = input.value.trim();
        if (isHandling[handling]) {
          return;
        }

        const { valid, msg } = validator(input.value);
        if (!valid) {
          responseText.innerText = msg;
        } else {
          let counter = 0;
          const dotInterval = setInterval(() => {
            responseText.innerText = ".".repeat(counter % 5);
            counter++;
          }, 100);

          // Send the request
          const url = develop
            ? "http://localhost:3000"
            : "https://www.kasparpoland.com";

          fetch(`${url}/${endpoint}`, {
            method: "POST",
            body: input.value,
          })
            .then((response) => {
              clearInterval(dotInterval);
              if (response.ok && response.status === 200) {
               
              }
              return response.json();
            })
            .then(json => {
              const { status, msg } = json;
              if (status === 200) {
                responseText.innerText = "thanks!";
              } else if (status === 500 && msg === "exists") {
                responseText.innerText = "you're already subscribed!";
              } else {
                throw new Error(json);
              }
            })
            .catch((error) => {
              console.log("Error: ", error);
              
              clearInterval(dotInterval);
              responseText.innerText = "error encountered, input not processed!";
            });
        }

        // Make text appear and clear input
        isHandling[handling] = true;
        input.value = "";
        setTimeout(() => {
          form.removeChild(responseText);
          isHandling[handling] = false;
        }, 3000);
      }

      function newAntIsValid(text) {
        let msg = "";
        if (text.length <= 2) {
          msg = "ant too short!";
        } else if (text.length >= 100) {
          msg = "ant too long!";
        }

        return {
          valid: msg === "",
          msg,
        };
      }

      function newsletterIsValid(text) {
        let msg = "";
        if (
          !/(?:[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:(2(5[0-5]|[0-4][0-9])|1[0-9][0-9]|[1-9]?[0-9]))\.){3}(?:(2(5[0-5]|[0-4][0-9])|1[0-9][0-9]|[1-9]?[0-9])|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])/.test(text)
        ) {
          msg = "invalid email!";
        }

        return {
          valid: msg === "",
          msg,
        };
      }

      const actions = {
        newAnt: {
          formID: "new-ant-form",
          inputID: "new-ant",
          validator: newAntIsValid,
          handling: "newAnt",
          endpoint: "api/new-ant",
        },
        newsletter: {
          formID: "newsletter-form",
          inputID: "newsletter",
          validator: newsletterIsValid,
          handling: "newsletter",
          endpoint: "api/ant-newsletter",
        },
      };
    </script>
    <title>types of ants</title>
  </head>
  <body style="padding: 20px;">
    <h1>types of ants</h1>
    <h3>
      <a href="https://www.github.com/kaspar-p/types-of-ants">
        check out the code on github
      </a>
    </h3>
    <div
      id="new-ant-form"
      style="display: flex; flex-direction: row; margin-bottom: 15px; padding: 10px"
    >
      <div style="margin-right: 5px;">have any new ant suggestions?</div>
      <input id="new-ant" />
      <button
        onclick="handle(actions.newAnt);"
        style="margin-left: 10px; margin-right: 10px"
      >
        submit ant suggestion
      </button>
    </div>
    <div
      id="newsletter-form"
      style="display: flex; flex-direction: row; margin-bottom: 15px; padding: 10px"
    >
      <div style="margin-right: 5px;">interested in monthly ant emails?</div>
      <input id="newsletter" />
      <button
        onclick="handle(actions.newsletter);"
        style="margin-left: 10px; margin-right: 10px"
      >
        join monthly newsletter
      </button>
    </div>
    <div id="banner">
      <div>discovered {amt} new ants on {date}:</div>
      <div id="scroll-container">
        <div id="scroll-text"></div>
      </div>
    </div>
    <div id="ant-filler" style="column-count: 4"></div>
  </body>
</html>
